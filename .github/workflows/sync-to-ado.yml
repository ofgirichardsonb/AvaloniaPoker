name: Sync to Azure DevOps

env:
  ACTIONS_STEP_DEBUG: true

on:
  push:
    branches:
      - '**'


jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Create branch in ADO if it doesn't exist
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -x
            az devops configure --defaults organization=https://dev.azure.com/ofgi project="Architecture Lab"
            pat="${{ secrets.AZURE_DEVOPS_EXT_PAT }}"
            echo $pat | az devops login
            branchName="${{ github.ref_name }}"
            currentSHA=${{ github.sha }}
            echo "Current SHA: $currentSHA"
            branchExists="$(az repos ref list -r AvaloniaPoker --filter heads/$branchName | jq -r '.[].objectId')"
            if [ -z "$branchExists" ]; then
              echo "Branch $branchName does not exist, creating it with current SHA..."
              az repos ref create --name "heads/$branchName" -r AvaloniaPoker --object-id $currentSHA
              echo "Branch created pointing to current commit"
            else
              echo "Branch $branchName already exists, updating it..."
              az repos ref update --name "heads/$branchName" -r AvaloniaPoker --object-id $currentSHA --old-object-id $branchExists
              echo "Branch updated"
            fi

      - name: Add Azure DevOps remote
        run: |
          git remote add ado "https://${{ secrets.AZURE_DEVOPS_EXT_PAT }}@dev.azure.com/ofgi/Architecture%20Lab/_git/AvaloniaPoker"
          git fetch ado

      - name: Debug Git Status
        run: |
          echo "Current branch: $(git branch --show-current)"
          echo "Remote info:"
          git remote -v
          echo "Git status:"
          git status
          echo "Git log:"
          git log --oneline -n 5
          echo "Remote refs:"
          git ls-remote ado
          
      - name: Push to Azure DevOps
        run: |
          git push ado HEAD:refs/heads/${{ github.ref_name }}

